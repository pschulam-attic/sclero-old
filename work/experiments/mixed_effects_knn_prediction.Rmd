Mixed Effects k-NN Prediction
=============================

```{r}
opts_chunk$set(fig.align="center", tidy=FALSE)
library(lme4)
library(ggplot2)
library(plyr)

for (fn in dir("../../R", full.names=TRUE)) source(fn)
```

Fit the model from [mixed effects prediction 3](mixed_effects_prediction_3.html).

```{r}
data <- ReadData("../../data/fvc.5.visits.csv")

mem.fit <- lmer(fvc ~ year + strFemale + strRaceId1 + aca + topo + rnp + pol3 + (1 + year|PtID), data = subset(data, year < 1.5))
```

Collect all patient coefficients into a single data frame.

```{r}
patient.coef <- coef(mem.fit)[["PtID"]]
factor.names <- names(patient.coef)[3:length(patient.coef)]
names(patient.coef) <- c("intercept", "slope", factor.names)
patient.coef[["PtID"]] <- rownames(patient.coef)

test <- merge(subset(data, year >= 1.5), patient.coef, by = "PtID")

test <- within(test, {
    intercept <- scale(intercept)
    slope <- scale(slope)
    gender.coef <- scale(ifelse(strFemale == 0, 0, strFemale1))
    race.coef <- scale(ifelse(strRaceId1 == 0, 0, eval(as.name(paste0("strRaceId1", strRaceId1)))))
    aca.coef <- scale(ifelse(aca == 0, 0, aca1))
    topo.coef <- scale(ifelse(topo == 0, 0, topo1))
    rnp.coef <- scale(ifelse(rnp == 0, 0, rnp1))
    pol3.coef <- scale(ifelse(pol3 == 0, 0, pol31))
})

test <- subset(test, select=c(PtID, year, fvc, fvc.sd,
                              intercept, slope, gender.coef,
                              race.coef, aca.coef, topo.coef,
                              rnp.coef, pol3.coef))

```

For every patient, find the patients that are most similar with
respect to the coefficient vector estimated from the mixed effect
model routine above. Once we've identified the nearest neighbors, use
a kernel regression smoother to approximate the trajectory of the
nearest neighbors, and use the curve to predict the patient's future
measurements.

```{r}
coef.names <- c("slope", "gender.coef", "race.coef",
                "aca.coef", "topo.coef", "rnp.coef", "pol3.coef")

patient.ids <- as.array(unique(as.integer(test[["PtID"]])))

PredictPatientId <- function(pid) PredictWithKnn(pid, test, k=5)
test <- adply(patient.ids, 1, PredictPatientId)
```
